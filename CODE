#include <Wire.h>
#include <Adafruit_INA219.h>
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>

#define FLAME_DO    D5
#define LED_PIN     D2
#define BUZZER_PIN  D7

// ThingSpeak API key (your key)
const String apiKey = "AAKX2IQX0E0MWY07";

// WiFi - replace with your network
const char* WIFI_SSID = "A";
const char* WIFI_PASS = "11111111";

Adafruit_INA219 ina219;

// Buzzer - continuous when flame detected

// ThingSpeak timing
const unsigned long TS_INTERVAL_MS = 15000; // 15s minimum for free channel
unsigned long lastThingSpeakAt = 0;

void setup() {
  Serial.begin(115200);
  delay(100);
  Serial.println("\n=== System Boot ===");

  // I2C on NodeMCU
  Wire.begin(D2, D1);

  // pins
  pinMode(FLAME_DO, INPUT);    // LOW = no flame, HIGH = flame detected
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);

  digitalWrite(LED_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);

  // INA219 init
  if (!ina219.begin()) {
    Serial.println("ERROR: INA219 not found! Check wiring (VCC=3.3V, GND, SDA=D2, SCL=D1).");
    while (1) delay(1000);
  }
  Serial.println("INA219 OK");

  // WiFi connect (non-blocking short wait, continue even if fails)
  Serial.print("Connecting WiFi ");
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  int tries = 0;
  while (WiFi.status() != WL_CONNECTED && tries < 40) {
    Serial.print(".");
    delay(300);
    tries++;
  }
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi connected. IP: " + WiFi.localIP().toString());
  } else {
    Serial.println("\nWiFi not connected (ThingSpeak uploads will be skipped until connected).");
  }

  lastThingSpeakAt = millis();
}

void loop() {
  unsigned long now = millis();

  // --- Read sensors ---
  int flameRaw = digitalRead(FLAME_DO);   
  bool flameDetected = (flameRaw == HIGH);  // HIGH = flame detected

  // Read power parameters continuously
  float shunt_mV   = ina219.getShuntVoltage_mV();
  float busVoltage = ina219.getBusVoltage_V();
  float current_mA = ina219.getCurrent_mA();
  float power_mW   = ina219.getPower_mW();

  // --- Serial output ---
  Serial.println(F("-----------------------------------"));
  Serial.print(F("Flame raw: ")); Serial.print(flameRaw);
  Serial.print(F("   FlameDetected: ")); Serial.println(flameDetected ? "ðŸ”¥ YES" : "NO");
  Serial.print(F("Bus Voltage: ")); Serial.print(busVoltage); Serial.println(" V");
  Serial.print(F("Shunt mV:    ")); Serial.print(shunt_mV); Serial.println(" mV");
  Serial.print(F("Current:     ")); Serial.print(current_mA); Serial.println(" mA");
  Serial.print(F("Power:       ")); Serial.print(power_mW); Serial.println(" mW");

  // --- LED indicator ---
  digitalWrite(LED_PIN, flameDetected ? LOW : HIGH);

  // --- Buzzer: ON when flame detected, OFF otherwise ---
  digitalWrite(BUZZER_PIN, flameDetected ? LOW : HIGH);

  // --- ThingSpeak upload every TS_INTERVAL_MS ---
  if (now - lastThingSpeakAt >= TS_INTERVAL_MS) {
    lastThingSpeakAt = now;
    if (WiFi.status() == WL_CONNECTED) {
      uploadToThingSpeak(current_mA, power_mW, busVoltage, flameDetected ? 1 : 0);
    } else {
      Serial.println(F("ThingSpeak skipped: WiFi not connected."));
    }
  }

  delay(500); // small sleep to avoid flooding serial
}

void uploadToThingSpeak(float current_mA, float power_mW, float busV, int flameFlag) {
  WiFiClient client;
  String url = "http://api.thingspeak.com/update?api_key=" + apiKey +
               "&field1=" + String(current_mA, 3) +
               "&field2=" + String(power_mW, 2) +
               "&field3=" + String(busV, 2) +
               "&field4=" + String(flameFlag);

  HTTPClient http;
  Serial.print(F("Uploading to ThingSpeak... "));
  http.begin(client, url);
  int code = http.GET();
  http.end();
  if (code == 200) {
    Serial.println(F("OK"));
  } else {
    Serial.print(F("FAILED (code: "));
    Serial.print(code);
    Serial.println(F(")"));
  }
}
